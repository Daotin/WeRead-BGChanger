// ==UserScript==
// @name         PCÂæÆ‰ø°ËØª‰π¶‰∏ªÈ¢òÂ¢ûÂº∫
// @namespace    http://tampermonkey.net/
// @version      0.4.4
// @description  ‰øÆÊîπÂæÆ‰ø°ËØª‰π¶ÁΩëÈ°µÁâàÁöÑÈòÖËØªËÉåÊôØËâ≤
// @author       Daotin
// @match        https://weread.qq.com/*
// @grant        GM_addStyle
// @grant        GM_setValue
// @grant        GM_getValue
// @require https://update.greasyfork.org/scripts/526757/1538158/%E8%83%8C%E6%99%AF%E5%9B%BE%E7%89%87base64%E9%85%8D%E7%BD%AE-%E5%BE%AE%E4%BF%A1%E8%AF%BB%E4%B9%A6%E8%84%9A%E6%9C%AC%E4%BD%BF%E7%94%A8.js
// @license MIT
// ==/UserScript==

(function () {
  "use strict";

  // Ê∑ªÂä†Ëá™ÂÆö‰πâÊ†∑Âºè
  GM_addStyle(`
        .bg-color-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px !important;
            height: 48px !important;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 16px;
            border-radius: 50%;
        }
        
        .bg-color-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        .bg-color-button.dark {
            color: #666;
        }
        
        .bg-color-button.white {
            color: #fff;
        }
        
        .bg-color-button.white:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .fullscreen-button {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 48px !important;
            height: 48px !important;
            margin: 0;
            padding: 0;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 20px;
            border-radius: 50%;
            transition: transform 0.3s ease;
        }

        .fullscreen-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }

        .fullscreen-button.dark {
            color: #666;
        }

        .fullscreen-button.white {
            color: #fff;
        }

        .fullscreen-button.white:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .fullscreen-button.active {
            transform: rotate(180deg);
        }
        
        .bg-color-panel {
            position: absolute;
            z-index: 110;
            transition: all .2s ease-in-out;
            width: 360px;
            box-sizing: border-box;
            padding: 16px 24px;
            border-radius: 16px;
            display: none;
            box-shadow: 0 10px 50px 0 #000;
        }
        
        .bg-color-panel.dark {
            background-color: #fff;
            color: #333;
            box-shadow: 0 10px 50px 0 rgba(0,0,0,.1);
        }
        
        .bg-color-panel.white {
            background-color: #262628;
            color: #fff;
        }

        .bg-color-panel.show {
            display: block;
        }

        .bg-color-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .bg-color-option {
            height: 40px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: transform 0.2s;
            position: relative;
            overflow: hidden;
        }
        
        .bg-color-option:hover {
            transform: scale(1.02);
        }
        
        .bg-color-option.dark {
            color: #333;
        }
        
        .bg-color-option.white {
            color: #fff;
        }

        .bg-color-option.image {
            background-size: cover !important;
            background-position: center !important;
            color: #fff !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.8);
        }

        .bg-color-option.image span {
            position: relative;
            z-index: 2;
        }

        .feedback-link {
            display: block;
            margin-top: 12px;
            text-align: center;
            font-size: 13px;
            transition: opacity 0.2s;
        }
        
        .feedback-link.dark {
            color: #999;
        }
        
        .feedback-link.dark:hover {
            text-decoration: underline;
        }
        
        .feedback-link.white {
            color: #999;
        }
        
        .feedback-link.white:hover {
            text-decoration: underline;
        }
    `);

  // È¢ÑËÆæÁöÑËÉåÊôØËâ≤ÈÄâÈ°π
  // Ëµ∑ÂêçÂèØ‰ª•ÂèÇËÄÉ‰∏≠ÂõΩ‰º†ÁªüËâ≤Ôºöhttps://chinacolor.org/
  const bgColors = [
    { name: "ÈªòËÆ§", value: "#ffffff", darkValue: "#1f1f1f" },
    { name: "Êä§ÁúºÁªø", value: "#c3e0c5", darkValue: "#1a291b" },
    { name: "Á±≥Ê±§ÈªÑ", value: "#eee5d3", darkValue: "#292824" },
    { name: "ËÉ≠ËÑÇÁ∫¢", value: "#fde6e0", darkValue: "#291f1d" },
    { name: "ÊúàÁôΩ", value: "#D4E5EF", darkValue: "#111111" },
    { name: "Áπ±Áäó", value: "#88BFB8", darkValue: "#241f16" },
    { name: "DeepSeekËìù", value: "#8093f1", darkValue: "#01167E" }, // #4d6bfe
    { name: "ClaudeÊ©ô", value: "#E0AB99", darkValue: "#5D2D1D" }, // #ab5235
    // ÂêàÂπ∂ËÉåÊôØÂõæÁâáÊï∞ÊçÆ
    ...window.backgroundImages.map((item) => {
      return {
        name: item.name,
        type: "image",
        size: item.size,
        value: item.light,
        darkValue: item.dark || item.light,
      };
    }),
  ];

  // localStorageÁöÑkey
  const STORAGE_KEY = "weread_bg_settings";

  // ‰øùÂ≠òËÉåÊôØËâ≤ËÆæÁΩÆ
  function saveBgSettings(colorIndex) {
    const settings = {
      colorIndex: colorIndex,
      isDark: isDarkMode(),
    };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
  }

  // Ëé∑Âèñ‰øùÂ≠òÁöÑËÉåÊôØËâ≤ËÆæÁΩÆ
  function getSavedBgSettings() {
    const settings = localStorage.getItem(STORAGE_KEY);
    return settings ? JSON.parse(settings) : null;
  }

  // Â∫îÁî®ËÉåÊôØËâ≤
  function applyBgColor(content, colorIndex, isDark) {
    if (colorIndex === -1 || colorIndex >= bgColors.length) {
      content.style.backgroundColor = "";
      content.style.backgroundImage = "";
      content.style.backgroundSize = "";
      content.style.backgroundPosition = "";
      content.style.backgroundAttachment = "";
      return;
    }

    const color = bgColors[colorIndex];
    console.log("applyBgColor==>", color, window.backgroundImages);
    const isImage = color.type === "image";

    if (isImage) {
      const imageUrl = isDark ? color.darkValue : color.value;
      content.style.backgroundColor = "";
      content.style.backgroundImage = `url(${imageUrl})`;
      content.style.backgroundSize = color.size ? color.size : "";
      content.style.backgroundPosition = "center";
      content.style.backgroundAttachment = "fixed";
    } else {
      const bgColor = isDark ? color.darkValue : color.value;
      content.style.backgroundImage = "";
      content.style.backgroundColor = bgColor;
    }
  }

  // ÈáçÁΩÆËÉåÊôØËâ≤‰∏∫ÈªòËÆ§
  function resetBackgroundColor() {
    const content = document.querySelector(".readerChapterContent");
    if (content) {
      content.style.backgroundColor = "";
      content.style.backgroundImage = "";
      content.style.backgroundSize = "";
      content.style.backgroundPosition = "";
      content.style.backgroundAttachment = "";
    }
    saveBgSettings(-1);
  }

  // ÂàõÂª∫ËÉåÊôØËâ≤ÊåâÈíÆ
  function createBgColorButton() {
    const button = document.createElement("button");
    button.className = "bg-color-button readerControls_item";
    button.innerHTML = "üé®";
    button.title = "ËÉåÊôØËâ≤";
    return button;
  }

  // ÂàõÂª∫ÂÖ®Â±èÊåâÈíÆ
  function createFullscreenButton() {
    const button = document.createElement("button");
    button.className = "fullscreen-button readerControls_item";
    button.innerHTML = "üîç";
    button.title = "ÂÖ®Â±èÈòÖËØª";
    return button;
  }

  // Âà§Êñ≠ÊòØÂê¶‰∏∫Ê∑±Ëâ≤Ê®°Âºè
  function isDarkMode() {
    const darkModeButton = document.querySelector(
      ".readerControls_item.white, .readerControls_item.dark"
    );
    return darkModeButton && darkModeButton.classList.contains("white");
  }

  // ÂàõÂª∫ËÉåÊôØËâ≤Èù¢Êùø
  function createBgColorPanel() {
    const panel = document.createElement("div");
    panel.className = "bg-color-panel";

    const grid = document.createElement("div");
    grid.className = "bg-color-grid";

    bgColors.forEach((color, index) => {
      const option = document.createElement("div");
      const isImage = color.type === "image";

      option.className = `bg-color-option ${isImage ? "image" : ""}`;

      if (isImage) {
        option.style.background = `url(${color.value})`;
        const span = document.createElement("span");
        span.textContent = color.name;
        option.appendChild(span);
      } else {
        option.style.backgroundColor = color.value;
        option.textContent = color.name;
      }

      option.onclick = () => {
        const content = document.querySelector(".readerChapterContent");
        if (content) {
          const isDark = isDarkMode();
          if (isImage) {
            const imageUrl = isDark ? color.darkValue : color.value;
            content.style.backgroundColor = "";
            content.style.backgroundImage = `url(${imageUrl})`;
            content.style.backgroundSize = color.size ? color.size : "";
            content.style.backgroundPosition = "center";
            content.style.backgroundAttachment = "fixed";
          } else {
            const bgColor = isDark ? color.darkValue : color.value;
            content.style.backgroundImage = "";
            content.style.backgroundColor = bgColor;
          }
          saveBgSettings(index);
        }
        panel.classList.remove("show");
      };
      grid.appendChild(option);
    });

    panel.appendChild(grid);

    // Ê∑ªÂä†ÂèçÈ¶àÈìæÊé•
    const feedbackLink = document.createElement("a");
    feedbackLink.className = "feedback-link";
    feedbackLink.href = "https://github.com/Daotin/WeRead-BGChanger/issues";
    feedbackLink.target = "_blank";
    feedbackLink.textContent = "ÈÉΩ‰∏çÂñúÊ¨¢ÔºüÂø´Êù•Êèê‰∫§‰Ω†ÁöÑÁæéÂõæ~";
    panel.appendChild(feedbackLink);

    return panel;
  }

  // Êõ¥Êñ∞Ê∑±ÊµÖËâ≤Ê®°Âºè
  function updateTheme(button, panel) {
    const isDark = isDarkMode();

    // Ëé∑Âèñ‰øùÂ≠òÁöÑËÉåÊôØËâ≤ËÆæÁΩÆ
    const savedSettings = getSavedBgSettings();
    const content = document.querySelector(".readerChapterContent");

    if (savedSettings && content) {
      // Â¶ÇÊûúÊ∑±Ëâ≤Ê®°ÂºèÁä∂ÊÄÅÊîπÂèòÔºåÈáçÁΩÆËÉåÊôØËâ≤
      if (savedSettings.isDark !== isDark) {
        resetBackgroundColor();
      } else {
        // Â∫îÁî®‰øùÂ≠òÁöÑËÉåÊôØËâ≤
        applyBgColor(content, savedSettings.colorIndex, isDark);
      }
    } else {
      resetBackgroundColor();
    }

    // Êõ¥Êñ∞ÊåâÈíÆÂíåÈù¢ÊùøÊ†∑Âºè
    button.className = `bg-color-button readerControls_item ${
      isDark ? "white" : "dark"
    }`;
    panel.className = `bg-color-panel ${isDark ? "white" : "dark"}`;

    // Êõ¥Êñ∞ÂèçÈ¶àÈìæÊé•Ê†∑Âºè
    const feedbackLink = panel.querySelector(".feedback-link");
    if (feedbackLink) {
      feedbackLink.className = `feedback-link ${isDark ? "white" : "dark"}`;
    }

    // Êõ¥Êñ∞ÈÄâÈ°πÊ†∑Âºè
    const options = panel.querySelectorAll(".bg-color-option");
    options.forEach((option, index) => {
      const color = bgColors[index];
      const isImage = color.type === "image";

      option.className = `bg-color-option ${isImage ? "image" : ""} ${
        isDark ? "white" : "dark"
      }`;

      if (isImage) {
        option.style.background = `url(${
          isDark ? color.darkValue : color.value
        })`;
      } else {
        option.style.backgroundColor = isDark ? color.darkValue : color.value;
      }
    });
  }

  // ÂàáÊç¢ÂÖ®Â±èÁä∂ÊÄÅ
  function toggleFullscreen(button) {
    const content = document.querySelector(".readerChapterContent");
    if (!content) return;

    if (!document.fullscreenElement) {
      content.requestFullscreen().catch((err) => {
        console.log(`Error attempting to enable fullscreen: ${err.message}`);
      });
      button.classList.add("active");
    } else {
      document.exitFullscreen();
      button.classList.remove("active");
    }
  }

  // ÁõëÂê¨DOMÂèòÂåñ,Ê∑ªÂä†ÊåâÈíÆÂíåÈù¢Êùø
  function init() {
    console.log("===init===");
    const targetNode = document.querySelector(".readerControls");
    if (!targetNode) return;

    const button = createBgColorButton();
    const panel = createBgColorPanel();
    const fullscreenButton = createFullscreenButton();

    // ÊèíÂÖ•Âà∞Ê∑±Ëâ≤/ÊµÖËâ≤ÊåâÈíÆÂêéÈù¢
    const darkModeButton = document.querySelector(
      ".readerControls_item.white, .readerControls_item.dark"
    );
    if (darkModeButton) {
      darkModeButton.parentNode.insertBefore(
        button,
        darkModeButton.nextSibling
      );
      darkModeButton.parentNode.insertBefore(
        fullscreenButton,
        button.nextSibling
      );
      document.body.appendChild(panel);

      // ÂàùÂßãÂåñ‰∏ªÈ¢òÂíåÂ∫îÁî®‰øùÂ≠òÁöÑËÉåÊôØËâ≤
      updateTheme(button, panel);

      // ÁõëÂê¨Ê∑±ÊµÖËâ≤Ê®°ÂºèÂàáÊç¢
      const themeObserver = new MutationObserver(() => {
        requestAnimationFrame(() => {
          updateTheme(button, panel);
          const isDark = isDarkMode();
          fullscreenButton.className = `fullscreen-button readerControls_item ${
            isDark ? "white" : "dark"
          }`;
        });
      });

      themeObserver.observe(darkModeButton, {
        attributes: true,
        attributeFilter: ["class"],
      });

      // ÁõëÂê¨ÂÖ®Â±èÁä∂ÊÄÅÂèòÂåñ
      document.addEventListener("fullscreenchange", () => {
        if (!document.fullscreenElement) {
          fullscreenButton.classList.remove("active");
        }
      });

      // Ê∑ªÂä†ÂÖ®Â±èÊåâÈíÆÁÇπÂáª‰∫ã‰ª∂
      fullscreenButton.onclick = () => {
        toggleFullscreen(fullscreenButton);
      };
    }

    // ÁÇπÂáªÊåâÈíÆÊòæÁ§∫/ÈöêËóèÈù¢Êùø
    button.onclick = (e) => {
      e.stopPropagation();
      const buttonRect = button.getBoundingClientRect();
      panel.style.bottom = window.innerHeight - buttonRect.top - 48 + "px";
      panel.style.right = window.innerWidth - buttonRect.left + 34 + "px";

      // Âú®ÊòæÁ§∫Èù¢ÊùøÂâçÊõ¥Êñ∞ÈÄâÈ°πÁöÑËÉåÊôØËâ≤
      const isDark = isDarkMode();
      const options = panel.querySelectorAll(".bg-color-option");
      options.forEach((option, index) => {
        option.style.backgroundColor = isDark
          ? bgColors[index].darkValue
          : bgColors[index].value;
      });

      panel.classList.toggle("show");
    };

    // ÁÇπÂáªÂÖ∂‰ªñÂå∫ÂüüÈöêËóèÈù¢Êùø
    document.addEventListener("click", (e) => {
      if (!panel.contains(e.target) && !button.contains(e.target)) {
        panel.classList.remove("show");
      }
    });
  }

  // ÁõëÂê¨È°µÈù¢ÂèòÂåñ
  const observer = new MutationObserver(() => {
    if (!document.querySelector(".bg-color-button")) {
      init();
    }
  });

  observer.observe(document.body, {
    childList: true,
    subtree: true,
  });

  // ÂàùÂßãÂåñ
  init();
})();
